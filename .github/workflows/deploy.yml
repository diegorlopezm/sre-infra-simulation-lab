name: ðŸš€ SRE Lab CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-configs:
    name: ðŸ”§ Validate Configurations
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Validate Docker Compose
      run: |
        echo "Validating Docker Compose configurations..."
        # âœ… ESTO SÃ falla si hay error de sintaxis
        if ! docker-compose -f infrastructure/web-apps/docker-compose.yml config -q; then
          echo "âŒ ERROR: web-apps/docker-compose.yml has syntax errors"
          exit 1
        fi
        
        if ! docker-compose -f infrastructure/automation/docker-compose.yml config -q; then
          echo "âŒ ERROR: automation/docker-compose.yml has syntax errors"  
          exit 1
        fi
        echo "âœ… All Docker configurations are valid"
        
    - name: ðŸ¤– Validate Ansible Syntax
      run: |
        cd infrastructure/automation/ansible/provisioning
        # âœ… ESTO SÃ falla si hay error de sintaxis
        if ! ansible-playbook --syntax-check deploy-infra.yml; then
          echo "âŒ ERROR: deploy-infra.yml has syntax errors"
          exit 1
        fi
        
        if ! ansible-playbook --syntax-check teardown-infra.yml; then
          echo "âŒ ERROR: teardown-infra.yml has syntax errors"
          exit 1  
        fi
        echo "âœ… All Ansible playbooks are syntactically correct"

  infrastructure-test:
    name: ðŸ§ª Infrastructure Tests
    runs-on: ubuntu-latest
    needs: validate-configs
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“Š Service Discovery Test
      run: |
        echo "Testing service discovery configuration..."
        # âœ… ESTO SÃ falla si no encuentra labels de Traefik
        if ! grep -r "traefik.http.routers" infrastructure/ > /dev/null; then
          echo "âŒ ERROR: No Traefik router labels found in infrastructure/"
          exit 1
        fi
        echo "âœ… Traefik labels configuration validated"
        grep -r "traefik.http.routers" infrastructure/ | head -3
        
    - name: ðŸ”— Network Configuration Test
      run: |
        echo "Validating network configurations..."
        # âœ… ESTO SÃ falla si no encuentra la red
        if ! grep -r "web-apps_default" infrastructure/ > /dev/null; then
          echo "âŒ ERROR: No services found using web-apps_default network"
          exit 1
        fi
        echo "âœ… Network configurations validated"
        grep -r "web-apps_default" infrastructure/ | head -3

  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [validate-configs, infrastructure-test]
    if: always()  # â­ NUEVO: Siempre se ejecuta, incluso si jobs anteriores fallan
    
    steps:
    - name: ðŸ“ˆ Generate Quality Report
      run: |
        echo "ðŸš€ SRE Infrastructure Lab - Quality Report" > quality-report.md
        echo "===========================================" >> quality-report.md
        echo "ðŸ“… Generated: $(date)" >> quality-report.md
        echo "ðŸŒ Live Demo: https://blog.diegoricardo.dev" >> quality-report.md
        echo "" >> quality-report.md
        echo "## ðŸ“Š Pipeline Status" >> quality-report.md
        echo "- âœ… Validate Configurations: ${{ needs.validate-configs.result }}" >> quality-report.md
        echo "- âœ… Infrastructure Tests: ${{ needs.infrastructure-test.result }}" >> quality-report.md
        echo "" >> quality-report.md
        echo "## ðŸ” Quick Links" >> quality-report.md  
        echo "- [ðŸ“– GitHub Repository](https://github.com/${{ github.repository }})" >> quality-report.md
        echo "- [ðŸŽ¯ Live Load Balancing Demo](https://blog.diegoricardo.dev)" >> quality-report.md
        echo "- ðŸ“Š Grafana Dashboard: https://grafana.diegoricardo.dev" >> quality-report.md
        
        echo "ðŸ“‹ Quality Report Generated:"
        cat quality-report.md
